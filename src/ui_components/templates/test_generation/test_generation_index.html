{% extends "base.html" %}
{% load static %}

{% block title %}Test Generation & Refinement{% endblock %}

{% block content_title %}Test Generation & Refinement{% endblock %}

{% block breadcrumb %}
<li class="breadcrumb-item"><a href="{% url 'ui_components:dashboard' %}">Home</a></li>
<li class="breadcrumb-item active" aria-current="page">Test Generation & Refinement</li>
{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/test_generation/test_generation.css' %}">
{% endblock %}

{% block content %}
<div class="container-fluid px-0">
    <!-- Tab navigation -->
    <ul class="nav nav-tabs mb-4" id="testGenerationTabs" role="tablist">
        <li class="nav-item" role="presentation">
            <button class="nav-link active" id="generate-tab" data-bs-toggle="tab" data-bs-target="#generate" type="button" role="tab" aria-controls="generate" aria-selected="true">
                <i class="fas fa-flask"></i> Generate Detailed Test Cases
            </button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="refine-tab" data-bs-toggle="tab" data-bs-target="#refine" type="button" role="tab" aria-controls="refine" aria-selected="false">
                <i class="fas fa-edit"></i> Review & Refine Test Case
            </button>
        </li>
    </ul>
    
    <!-- Tab content -->
    <div class="tab-content" id="testGenerationTabsContent">
        <!-- Generate Detailed Test Cases Tab -->
        <div class="tab-pane fade show active" id="generate" role="tabpanel" aria-labelledby="generate-tab">
            <div class="card">
                <div class="card-header">
                    <h4>Generate Detailed Test Cases</h4>
                    <p class="text-muted">Create comprehensive test cases from requirements or direct input.</p>
                </div>
                <div class="card-body">
                    <form id="generateTestCaseForm">
                        {% csrf_token %}
                        
                        <!-- Input Source Section -->
                        <div class="form-section mb-4">
                            <h5>Input Source</h5>
                            <div class="form-group mt-3">
                                <div class="input-source-selection">
                                    <div class="form-check form-check-inline">
                                        <input class="form-check-input" type="radio" name="inputSource" id="sourceRequirements" value="requirements" checked>
                                        <label class="form-check-label" for="sourceRequirements">From Processed Requirements</label>
                                    </div>
                                    <div class="form-check form-check-inline">
                                        <input class="form-check-input" type="radio" name="inputSource" id="sourcePrompt" value="prompt">
                                        <label class="form-check-label" for="sourcePrompt">Direct Prompt/Keywords</label>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Processed Requirements Section -->
                        <div class="form-section mb-4" id="requirementsSection">
                            <div id="processedRequirementsStatus" class="alert alert-info">
                                <div class="d-flex align-items-center">
                                    <div class="me-3">
                                        <i class="fas fa-info-circle fa-lg"></i>
                                    </div>
                                    <div>
                                        <span class="status-text">No processed requirements found. Please go to the Requirements section first or use direct prompt.</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Direct Prompt Input -->
                        <div class="form-section mb-4" id="promptSection" style="display: none;">
                            <h5>Enter Prompt or Keywords</h5>
                            <div class="form-group">
                                <textarea class="form-control" id="promptInput" name="prompt" rows="4" placeholder="Example: Generate login test cases for admin user with valid and invalid credentials"></textarea>
                                <div class="form-text">Describe the functionality you want to test as specifically as possible.</div>
                            </div>
                        </div>
                        
                        <!-- Configuration Options -->
                        <div class="form-section mb-4">
                            <h5>Configuration</h5>
                            <div class="row mt-3">
                                <div class="col-md-6">
                                    <div class="form-group">
                                        <label for="detailLevel" class="form-label">Level of Detail</label>
                                        <select class="form-select" id="detailLevel" name="detailLevel">
                                            <option value="high">High (Comprehensive steps & validations)</option>
                                            <option value="medium" selected>Medium (Standard detail)</option>
                                            <option value="low">Low (Basic steps only)</option>
                                        </select>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="form-group">
                                        <label for="targetFormat" class="form-label">Target Format</label>
                                        <select class="form-select" id="targetFormat" name="targetFormat">
                                            <option value="preview" selected>Preview First</option>
                                            <option value="excel">Excel Document</option>
                                            <option value="word">Word Document</option>
                                            <option value="pdf">PDF Document</option>
                                        </select>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Action Buttons -->
                        <div class="form-actions">
                            <button type="button" id="generateTestCaseBtn" class="btn btn-primary">
                                <i class="fas fa-cogs"></i> Generate Test Cases
                            </button>
                            <button type="button" id="cancelGenerateBtn" class="btn btn-secondary ms-2">
                                <i class="fas fa-times"></i> Cancel
                            </button>
                        </div>
                    </form>
                    
                    <!-- Progress Indicator (initially hidden) -->
                    <div id="generationProgress" class="generation-progress mt-4 d-none">
                        <div class="progress">
                            <div class="progress-bar progress-bar-striped progress-bar-animated" role="progressbar" aria-valuenow="75" aria-valuemin="0" aria-valuemax="100" style="width: 75%"></div>
                        </div>
                        <p class="progress-status text-center mt-2">Generating test cases... This may take a few moments.</p>
                    </div>
                    
                    <!-- Output Area (initially hidden) -->
                    <div id="generationOutput" class="generation-output mt-4 d-none">
                        <div class="card">
                            <div class="card-header d-flex justify-content-between align-items-center">
                                <h5 class="mb-0">Generated Test Cases</h5>
                                <div class="actions">
                                    <button type="button" id="exportExcelBtn" class="btn btn-sm btn-success">
                                        <i class="fas fa-file-excel"></i> Export to Excel
                                    </button>
                                    <button type="button" id="compareRepoBtn" class="btn btn-sm btn-info ms-2">
                                        <i class="fas fa-code-branch"></i> Compare with Repository
                                    </button>
                                </div>
                            </div>
                            <div class="card-body">
                                <div id="testCasePreview" class="test-case-preview">
                                    <!-- Test case preview will be displayed here -->
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Review & Refine Test Case Tab -->
        <div class="tab-pane fade" id="refine" role="tabpanel" aria-labelledby="refine-tab">
            <div class="card">
                <div class="card-header">
                    <h4>Review & Refine Test Case</h4>
                    <p class="text-muted">Analyze and enhance existing test cases with AI suggestions.</p>
                </div>
                <div class="card-body">
                    <form id="refineTestCaseForm" method="post" enctype="multipart/form-data">
                        {% csrf_token %}
                        
                        <!-- File Upload Area -->
                        <div class="form-section mb-4">
                            <h5>Upload Test Case</h5>
                            <div class="file-upload-container mt-3">
                                <div id="refinement-drop-area" class="file-upload-area">
                                    <i class="fas fa-upload fa-2x"></i>
                                    <span class="upload-text">Drag & drop a test case file here or click to browse</span>
                                    <span class="upload-hint">Supported formats: Excel, Word</span>
                                    
                                    <input type="file" name="test_case_file" id="test_case_file" class="hidden-file-input" 
                                         accept=".doc,.docx,.xls,.xlsx" required>
                                </div>
                                
                                <div id="refinement-file-preview" class="file-preview d-none">
                                    <i class="fas fa-file"></i>
                                    <div class="file-info">
                                        <span id="refinement-file-name" class="file-name"></span>
                                        <span id="refinement-file-size" class="file-size"></span>
                                    </div>
                                    <button type="button" id="refinement-remove-file" class="remove-file-btn">
                                        <i class="fas fa-times"></i>
                                    </button>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Action Buttons -->
                        <div class="form-actions">
                            <button type="button" id="analyzeTestCaseBtn" class="btn btn-primary" disabled>
                                <i class="fas fa-search"></i> Analyze Test Case
                            </button>
                            <button type="button" id="cancelRefineBtn" class="btn btn-secondary ms-2">
                                <i class="fas fa-times"></i> Cancel
                            </button>
                        </div>
                    </form>
                    
                    <!-- Progress Indicator (initially hidden) -->
                    <div id="refinementProgress" class="refinement-progress mt-4 d-none">
                        <div class="progress">
                            <div class="progress-bar progress-bar-striped progress-bar-animated" role="progressbar" aria-valuenow="75" aria-valuemin="0" aria-valuemax="100" style="width: 75%"></div>
                        </div>
                        <p class="progress-status text-center mt-2">Analyzing test case... This may take a few moments.</p>
                    </div>
                    
                    <!-- Comparison View (initially hidden) -->
                    <div id="refinementComparison" class="refinement-comparison mt-4 d-none">
                        <div class="card">
                            <div class="card-header">
                                <h5>Refinement Suggestions</h5>
                            </div>
                            <div class="card-body">
                                <div class="comparison-container">
                                    <!-- Side-by-side comparison will be displayed here -->
                                    <div class="row">
                                        <div class="col-md-6">
                                            <div class="original-test-case">
                                                <h5>Original Test Case</h5>
                                                <div id="originalTestCase" class="test-case-content">
                                                    <!-- Original test case content -->
                                                </div>
                                            </div>
                                        </div>
                                        <div class="col-md-6">
                                            <div class="refined-test-case">
                                                <h5>Suggested Refinements</h5>
                                                <div id="refinedTestCase" class="test-case-content">
                                                    <!-- Refined test case content -->
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <!-- AI Suggestions Box -->
                                    <div class="ai-suggestions mt-4">
                                        <h5>AI Analysis & Recommendations</h5>
                                        <div id="aiSuggestions" class="ai-suggestions-content">
                                            <!-- AI suggestions will be displayed here -->
                                        </div>
                                    </div>
                                    
                                    <!-- Action Buttons -->
                                    <div class="refinement-actions mt-4">
                                        <button type="button" id="acceptSuggestionsBtn" class="btn btn-success">
                                            <i class="fas fa-check"></i> Accept & Update
                                        </button>
                                        <!-- Add this button to the refinement-actions div -->
                                        <button type="button" id="downloadRefinedBtn" class="btn btn-primary ms-2">
                                            <i class="fas fa-download"></i> Download
                                        </button>
                                        <button type="button" id="notifyOwnerBtn" class="btn btn-info ms-2">
                                            <i class="fas fa-bell"></i> Notify Owner
                                        </button>
                                        <button type="button" id="markObsoleteBtn" class="btn btn-warning ms-2">
                                            <i class="fas fa-archive"></i> Mark as Obsolete
                                        </button>
                                        <button type="button" id="discardSuggestionsBtn" class="btn btn-secondary ms-2">
                                            <i class="fas fa-trash"></i> Discard Suggestions
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="{% static 'js/test_generation/ui_utils.js' %}"></script>
<script src="{% static 'js/test_generation/api_service.js' %}"></script>
<script src="{% static 'js/test_generation/generate_test_cases.js' %}"></script>
<script src="{% static 'js/test_generation/test_generation_main.js' %}"></script>
<script src="{% static 'js/test_generation/refine_test_cases.js' %}"></script>
{% endblock %}



<!-- EMERGENCY RADIO BUTTON FIX -->
<script type="text/javascript">

  // This script runs immediately after the page loads
  (function() {
    console.log('*** EMERGENCY RADIO BUTTON FIX RUNNING ***');
    

    // Function to fix radio buttons
    function fixRadioButtons() {
      console.log('Running emergency radio button fix');
      
      // Get elements by ID with fallback to querySelector
      function getElement(id) {
        return document.getElementById(id) || document.querySelector('#' + id);
      }
      
      // Get the radio buttons and content sections
      const sourceRequirements = getElement('sourceRequirements');
      const sourcePrompt = getElement('sourcePrompt');
      const requirementsSection = getElement('requirementsSection');
      const promptSection = getElement('promptSection');
      
      console.log('Found elements:', {
        sourceRequirements: !!sourceRequirements,
        sourcePrompt: !!sourcePrompt,
        requirementsSection: !!requirementsSection,
        promptSection: !!promptSection
      });
      
      // Exit if any elements are missing
      if (!sourceRequirements || !sourcePrompt || !requirementsSection || !promptSection) {
        console.error('Could not find all required elements for radio button fix');
        return;
      }
      
      // Remove event listeners (might help with conflicts)
      const clonedReqRadio = sourceRequirements.cloneNode(true);
      const clonedPromptRadio = sourcePrompt.cloneNode(true);
      
      // Replace the original elements with clones to remove all listeners
      sourceRequirements.parentNode.replaceChild(clonedReqRadio, sourceRequirements);
      sourcePrompt.parentNode.replaceChild(clonedPromptRadio, sourcePrompt);
      
      // Update our references to the new elements
      const reqRadio = clonedReqRadio;
      const promptRadio = clonedPromptRadio;
      
      // Function to show requirements section
      function showRequirementsSection() {
        console.log('DIRECT FIX: Showing requirements section');
        
        // Apply multiple visibility techniques
        requirementsSection.style.display = 'block';
        promptSection.style.display = 'none';
        
        requirementsSection.classList.remove('d-none');
        promptSection.classList.add('d-none');
      }
      
      // Function to show prompt section
      function showPromptSection() {
        console.log('DIRECT FIX: Showing prompt section');
        
        // Apply multiple visibility techniques
        requirementsSection.style.display = 'none';
        promptSection.style.display = 'block';
        
        requirementsSection.classList.add('d-none');
        promptSection.classList.remove('d-none');
      }
      
      // Add click event listeners
      reqRadio.addEventListener('click', function() {
        console.log('Requirements radio clicked');
        showRequirementsSection();
      });
      
      promptRadio.addEventListener('click', function() {
        console.log('Prompt radio clicked');
        showPromptSection();
      });
      
      // Also add change listeners as a backup
      reqRadio.addEventListener('change', function() {
        console.log('Requirements radio changed');
        if (this.checked) {
          showRequirementsSection();
        }
      });
      
      promptRadio.addEventListener('change', function() {
        console.log('Prompt radio changed');
        if (this.checked) {
          showPromptSection();
        }
      });
      
      // Also add listeners to labels for extra reliability
      const reqLabel = document.querySelector('label[for="sourceRequirements"]');
      const promptLabel = document.querySelector('label[for="sourcePrompt"]');
      
      if (reqLabel) {
        reqLabel.addEventListener('click', function() {
          console.log('Requirements label clicked');
          reqRadio.checked = true;
          showRequirementsSection();
        });
      }
      
      if (promptLabel) {
        promptLabel.addEventListener('click', function() {
          console.log('Prompt label clicked');
          promptRadio.checked = true;
          showPromptSection();
        });
      }
      
      // Set initial state
      console.log('Setting initial radio button state');
      if (promptRadio.checked) {
        showPromptSection();
      } else {
        showRequirementsSection();
      }
      
      // Add manual toggle button for testing/emergency use
      const form = document.querySelector('#generateTestCaseForm');
      if (form) {
        const toggleButton = document.createElement('button');
        toggleButton.type = 'button';
        toggleButton.textContent = 'Toggle Input Method';
        toggleButton.className = 'btn btn-sm btn-warning mt-2 mb-2';
        toggleButton.style.display = 'none';
        toggleButton.addEventListener('click', function() {
          console.log('Manual toggle button clicked');
          if (promptRadio.checked) {
            reqRadio.checked = true;
            showRequirementsSection();
          } else {
            promptRadio.checked = true;
            showPromptSection();
          }
        });
        
        // Insert after the radio buttons
        const inputSourceDiv = document.querySelector('.input-source-selection');
        if (inputSourceDiv) {
          inputSourceDiv.parentNode.insertBefore(toggleButton, inputSourceDiv.nextSibling);
        }
      }
    }
    
    // Run the fix when DOM is loaded
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', fixRadioButtons);
    } else {
      // DOM already loaded, run immediately
      fixRadioButtons();
    }
    
    // Also run the fix after a delay to ensure all other scripts have initialized
    setTimeout(fixRadioButtons, 500);
    
    // And run it one more time after all resources have loaded
    window.addEventListener('load', fixRadioButtons);
  })();
</script>
