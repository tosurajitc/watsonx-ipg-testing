{% extends "base.html" %}
{% load static %}

{% block title %}Reporting - Watsonx for IPG Testing{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/reporting/reporting.css' %}">
{% endblock %}

{% block content_title %}Reporting{% endblock %}

{% block breadcrumb %}
<li class="breadcrumb-item"><a href="/">Home</a></li>
<li class="breadcrumb-item active" aria-current="page">Reporting</li>
{% endblock %}

{% block content %}
<div class="row">
    <!-- ALM Report Utility Card -->
    <div class="col-lg-12 mb-4">
        <div class="card">
            <div class="card-header">
                <h5 class="card-title mb-0">
                    <i class="fas fa-file-excel me-2"></i>Run ALM Report Utility
                </h5>
            </div>
            <div class="card-body">
                <div class="mb-4">
                    <div class="connection-status d-flex align-items-center mb-3">
                        <span class="me-2">Excel Macro Utility Connection:</span>
                        <span id="connectionStatus" class="badge bg-success">Connected</span>
                        <button id="refreshConnection" class="btn btn-sm btn-outline-secondary ms-2" title="Refresh Connection">
                            <i class="fas fa-sync-alt"></i>
                        </button>
                    </div>
                    <p class="text-muted small">This utility connects to ALM and fetches execution and defect reports using Excel macros.</p>
                </div>
                
                <div class="action-buttons mb-4">
                    <button id="fetchReportBtn" class="btn btn-primary">
                        <i class="fas fa-download me-2"></i>Fetch ALM Execution & Defect Report
                    </button>
                </div>
                
                <div id="progressContainer" class="progress-container mb-3 d-none">
                    <label for="reportProgress" class="form-label mb-1">Report Generation Progress:</label>
                    <div class="progress">
                        <div id="reportProgress" class="progress-bar progress-bar-striped progress-bar-animated" role="progressbar" style="width: 0%"></div>
                    </div>
                    <small id="progressStatus" class="text-muted">Initializing report generation...</small>
                </div>
                
                <div id="statusLogContainer" class="status-log-container d-none">
                    <label class="form-label">Status Log:</label>
                    <div id="statusLog" class="status-log">
                        <div class="log-entry">
                            <span class="timestamp">12:34:56</span>
                            <span class="log-message">Ready to fetch reports from ALM.</span>
                        </div>
                    </div>
                </div>
                
                <div id="completionActions" class="completion-actions d-none mt-4">
                    <div class="alert alert-success">
                        <i class="fas fa-check-circle me-2"></i>Report generated successfully!
                    </div>
                    <button id="shareReportBtn" class="btn btn-success">
                        <i class="fas fa-share-alt me-2"></i>Share Report with Test Lead
                    </button>
                    <button id="viewReportBtn" class="btn btn-info">
                        <i class="fas fa-eye me-2"></i>View Report
                    </button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- View Reports Card -->
    <div class="col-lg-12">
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="card-title mb-0">
                    <i class="fas fa-file-alt me-2"></i>View Reports
                </h5>
                <div class="card-tools">
                    <button id="refreshReportsList" class="btn btn-sm btn-outline-secondary" title="Refresh Reports List">
                        <i class="fas fa-sync-alt"></i>
                    </button>
                </div>
            </div>
            <div class="card-body">
                <!-- Report Filters -->
                <div class="row mb-4">
                    <div class="col-md-3">
                        <label for="reportTypeFilter" class="form-label">Report Type</label>
                        <select id="reportTypeFilter" class="form-select">
                            <option value="">All Types</option>
                            <option value="execution">Execution Summary</option>
                            <option value="defect">Defect Report</option>
                            <option value="analysis">Analysis Report</option>
                        </select>
                    </div>
                    <div class="col-md-3">
                        <label for="dateRangeFilter" class="form-label">Date Range</label>
                        <select id="dateRangeFilter" class="form-select">
                            <option value="">All Time</option>
                            <option value="today">Today</option>
                            <option value="week">This Week</option>
                            <option value="month">This Month</option>
                            <option value="custom">Custom Range</option>
                        </select>
                    </div>
                    <div class="col-md-4">
                        <label for="searchFilter" class="form-label">Search</label>
                        <div class="input-group">
                            <input type="text" id="searchFilter" class="form-control" placeholder="Search reports...">
                            <button class="btn btn-outline-secondary" type="button">
                                <i class="fas fa-search"></i>
                            </button>
                        </div>
                    </div>
                    <div class="col-md-2 d-flex align-items-end">
                        <button id="applyFilters" class="btn btn-primary w-100">Apply Filters</button>
                    </div>
                </div>
                
                <!-- Custom Date Range Selector (Hidden by default) -->
                <div id="customDateRange" class="row mb-4 d-none">
                    <div class="col-md-6">
                        <label for="startDate" class="form-label">Start Date</label>
                        <input type="date" id="startDate" class="form-control">
                    </div>
                    <div class="col-md-6">
                        <label for="endDate" class="form-label">End Date</label>
                        <input type="date" id="endDate" class="form-control">
                    </div>
                </div>
                
                <!-- Reports Table -->
                <div class="table-responsive">
                    <table class="table table-striped table-hover">
                        <thead>
                            <tr>
                                <th scope="col">
                                    <a href="#" class="sort-link" data-sort="name">
                                        Report Name
                                        <i class="fas fa-sort ms-1"></i>
                                    </a>
                                </th>
                                <th scope="col">
                                    <a href="#" class="sort-link" data-sort="type">
                                        Type
                                        <i class="fas fa-sort ms-1"></i>
                                    </a>
                                </th>
                                <th scope="col">
                                    <a href="#" class="sort-link" data-sort="date">
                                        Generated Date
                                        <i class="fas fa-sort ms-1"></i>
                                    </a>
                                </th>
                                <th scope="col">Generated By</th>
                                <th scope="col">Actions</th>
                            </tr>
                        </thead>
                        <tbody id="reportsTableBody">
                            <!-- Sample data, will be populated by JavaScript -->
                            <tr>
                                <td>April Sprint 1 - Execution Summary</td>
                                <td><span class="badge bg-primary">Execution</span></td>
                                <td>May 5, 2025</td>
                                <td>John Doe</td>
                                <td>
                                    <div class="btn-group btn-group-sm">
                                        <a href="#" class="btn btn-outline-primary" title="View">
                                            <i class="fas fa-eye"></i>
                                        </a>
                                        <a href="#" class="btn btn-outline-secondary" title="Download">
                                            <i class="fas fa-download"></i>
                                        </a>
                                        <a href="#" class="btn btn-outline-success" title="Share">
                                            <i class="fas fa-share-alt"></i>
                                        </a>
                                    </div>
                                </td>
                            </tr>
                            <tr>
                                <td>Regression Test - Defect Report</td>
                                <td><span class="badge bg-danger">Defect</span></td>
                                <td>May 3, 2025</td>
                                <td>Jane Smith</td>
                                <td>
                                    <div class="btn-group btn-group-sm">
                                        <a href="#" class="btn btn-outline-primary" title="View">
                                            <i class="fas fa-eye"></i>
                                        </a>
                                        <a href="#" class="btn btn-outline-secondary" title="Download">
                                            <i class="fas fa-download"></i>
                                        </a>
                                        <a href="#" class="btn btn-outline-success" title="Share">
                                            <i class="fas fa-share-alt"></i>
                                        </a>
                                    </div>
                                </td>
                            </tr>
                            <tr>
                                <td>Q2 Test Metrics - Analysis Report</td>
                                <td><span class="badge bg-info">Analysis</span></td>
                                <td>May 1, 2025</td>
                                <td>Robert Johnson</td>
                                <td>
                                    <div class="btn-group btn-group-sm">
                                        <a href="#" class="btn btn-outline-primary" title="View">
                                            <i class="fas fa-eye"></i>
                                        </a>
                                        <a href="#" class="btn btn-outline-secondary" title="Download">
                                            <i class="fas fa-download"></i>
                                        </a>
                                        <a href="#" class="btn btn-outline-success" title="Share">
                                            <i class="fas fa-share-alt"></i>
                                        </a>
                                    </div>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
                
                <!-- Pagination -->
                <nav aria-label="Reports pagination">
                    <ul class="pagination justify-content-center">
                        <li class="page-item disabled">
                            <a class="page-link" href="#" tabindex="-1" aria-disabled="true">Previous</a>
                        </li>
                        <li class="page-item active"><a class="page-link" href="#">1</a></li>
                        <li class="page-item"><a class="page-link" href="#">2</a></li>
                        <li class="page-item"><a class="page-link" href="#">3</a></li>
                        <li class="page-item">
                            <a class="page-link" href="#">Next</a>
                        </li>
                    </ul>
                </nav>
            </div>
        </div>
    </div>
</div>

<!-- Share Report Modal -->
<div class="modal fade" id="shareReportModal" tabindex="-1" aria-labelledby="shareReportModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="shareReportModalLabel">Share Report with Test Lead</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="shareReportForm">
                    <div class="mb-3">
                        <label for="recipientEmail" class="form-label">Recipient Email</label>
                        <input type="email" class="form-control" id="recipientEmail" value="testlead@example.com">
                    </div>
                    <div class="mb-3">
                        <label for="emailSubject" class="form-label">Subject</label>
                        <input type="text" class="form-control" id="emailSubject" value="ALM Test Execution & Defect Report - May 2025">
                    </div>
                    <div class="mb-3">
                        <label for="emailMessage" class="form-label">Message</label>
                        <textarea class="form-control" id="emailMessage" rows="4">Please find attached the latest ALM test execution and defect report for your review.

The report contains information on test cases executed, their status, and any defects identified during testing.

Let me know if you have any questions.

Regards,
Watsonx IPG Testing Team</textarea>
                    </div>
                    <div class="form-check mb-3">
                        <input class="form-check-input" type="checkbox" id="attachReportCheck" checked>
                        <label class="form-check-label" for="attachReportCheck">
                            Attach Report
                        </label>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" id="sendReportBtn">Send Report</button>
            </div>
        </div>
    </div>
</div>

<!-- View Report Modal -->
<div class="modal fade" id="viewReportModal" tabindex="-1" aria-labelledby="viewReportModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="viewReportModalLabel">Test Execution & Defect Report</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <ul class="nav nav-tabs" id="reportTabs" role="tablist">
                    <li class="nav-item" role="presentation">
                        <button class="nav-link active" id="execution-tab" data-bs-toggle="tab" data-bs-target="#execution-tab-pane" type="button" role="tab" aria-controls="execution-tab-pane" aria-selected="true">Execution Summary</button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="defects-tab" data-bs-toggle="tab" data-bs-target="#defects-tab-pane" type="button" role="tab" aria-controls="defects-tab-pane" aria-selected="false">Defects</button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="metrics-tab" data-bs-toggle="tab" data-bs-target="#metrics-tab-pane" type="button" role="tab" aria-controls="metrics-tab-pane" aria-selected="false">Metrics</button>
                    </li>
                </ul>
                <div class="tab-content pt-3" id="reportTabContent">
                    <!-- Execution Summary Tab -->
                    <div class="tab-pane fade show active" id="execution-tab-pane" role="tabpanel" aria-labelledby="execution-tab" tabindex="0">
                        <div class="report-summary mb-4">
                            <div class="row">
                                <div class="col-md-3">
                                    <div class="summary-item">
                                        <span class="summary-label">Total Test Cases</span>
                                        <span class="summary-value">126</span>
                                    </div>
                                </div>
                                <div class="col-md-3">
                                    <div class="summary-item">
                                        <span class="summary-label">Passed</span>
                                        <span class="summary-value text-success">98</span>
                                    </div>
                                </div>
                                <div class="col-md-3">
                                    <div class="summary-item">
                                        <span class="summary-label">Failed</span>
                                        <span class="summary-value text-danger">18</span>
                                    </div>
                                </div>
                                <div class="col-md-3">
                                    <div class="summary-item">
                                        <span class="summary-label">Blocked</span>
                                        <span class="summary-value text-warning">10</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Execution Table -->
                        <div class="table-responsive">
                            <table class="table table-sm">
                                <thead>
                                    <tr>
                                        <th>Test Case ID</th>
                                        <th>Name</th>
                                        <th>Status</th>
                                        <th>Execution Date</th>
                                        <th>Executed By</th>
                                        <th>Duration</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <!-- Sample data -->
                                    <tr>
                                        <td>TC-1001</td>
                                        <td>Login with valid credentials</td>
                                        <td><span class="badge bg-success">Passed</span></td>
                                        <td>May 5, 2025</td>
                                        <td>Automation</td>
                                        <td>2.4s</td>
                                    </tr>
                                    <tr>
                                        <td>TC-1002</td>
                                        <td>Login with invalid credentials</td>
                                        <td><span class="badge bg-success">Passed</span></td>
                                        <td>May 5, 2025</td>
                                        <td>Automation</td>
                                        <td>1.8s</td>
                                    </tr>
                                    <tr>
                                        <td>TC-1003</td>
                                        <td>Password reset functionality</td>
                                        <td><span class="badge bg-danger">Failed</span></td>
                                        <td>May 5, 2025</td>
                                        <td>Automation</td>
                                        <td>3.2s</td>
                                    </tr>
                                    <tr>
                                        <td>TC-1004</td>
                                        <td>User profile update</td>
                                        <td><span class="badge bg-warning">Blocked</span></td>
                                        <td>May 5, 2025</td>
                                        <td>John Doe</td>
                                        <td>N/A</td>
                                    </tr>
                                    <tr>
                                        <td>TC-1005</td>
                                        <td>Account lockout after failed attempts</td>
                                        <td><span class="badge bg-success">Passed</span></td>
                                        <td>May 5, 2025</td>
                                        <td>Automation</td>
                                        <td>4.6s</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                    
                    <!-- Defects Tab -->
                    <div class="tab-pane fade" id="defects-tab-pane" role="tabpanel" aria-labelledby="defects-tab" tabindex="0">
                        <div class="report-summary mb-4">
                            <div class="row">
                                <div class="col-md-3">
                                    <div class="summary-item">
                                        <span class="summary-label">Total Defects</span>
                                        <span class="summary-value">18</span>
                                    </div>
                                </div>
                                <div class="col-md-3">
                                    <div class="summary-item">
                                        <span class="summary-label">Critical</span>
                                        <span class="summary-value text-danger">3</span>
                                    </div>
                                </div>
                                <div class="col-md-3">
                                    <div class="summary-item">
                                        <span class="summary-label">Major</span>
                                        <span class="summary-value text-warning">8</span>
                                    </div>
                                </div>
                                <div class="col-md-3">
                                    <div class="summary-item">
                                        <span class="summary-label">Minor</span>
                                        <span class="summary-value text-info">7</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Defects Table -->
                        <div class="table-responsive">
                            <table class="table table-sm">
                                <thead>
                                    <tr>
                                        <th>Defect ID</th>
                                        <th>Summary</th>
                                        <th>Severity</th>
                                        <th>Status</th>
                                        <th>Assigned To</th>
                                        <th>Reported Date</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <!-- Sample data -->
                                    <tr>
                                        <td>DEF-501</td>
                                        <td>Password reset email not being sent</td>
                                        <td><span class="badge bg-danger">Critical</span></td>
                                        <td>Open</td>
                                        <td>Jane Smith</td>
                                        <td>May 5, 2025</td>
                                    </tr>
                                    <tr>
                                        <td>DEF-502</td>
                                        <td>Profile image upload fails with large files</td>
                                        <td><span class="badge bg-warning">Major</span></td>
                                        <td>In Progress</td>
                                        <td>Robert Johnson</td>
                                        <td>May 5, 2025</td>
                                    </tr>
                                    <tr>
                                        <td>DEF-503</td>
                                        <td>Account lockout message unclear to users</td>
                                        <td><span class="badge bg-info">Minor</span></td>
                                        <td>Open</td>
                                        <td>Unassigned</td>
                                        <td>May 5, 2025</td>
                                    </tr>
                                    <tr>
                                        <td>DEF-504</td>
                                        <td>Session timeout without warning</td>
                                        <td><span class="badge bg-warning">Major</span></td>
                                        <td>Open</td>
                                        <td>Jane Smith</td>
                                        <td>May 5, 2025</td>
                                    </tr>
                                    <tr>
                                        <td>DEF-505</td>
                                        <td>Security question answers case sensitive when shouldn't be</td>
                                        <td><span class="badge bg-danger">Critical</span></td>
                                        <td>In Progress</td>
                                        <td>Robert Johnson</td>
                                        <td>May 5, 2025</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                    
                    <!-- Metrics Tab -->
                    <div class="tab-pane fade" id="metrics-tab-pane" role="tabpanel" aria-labelledby="metrics-tab" tabindex="0">
                        <div class="row">
                            <div class="col-md-6 mb-4">
                                <div class="card">
                                    <div class="card-header">
                                        <h6 class="card-title mb-0">Test Execution Status</h6>
                                    </div>
                                    <div class="card-body">
                                        <div class="chart-container" style="height: 300px;">
                                            <!-- Chart will be rendered by JS -->
                                            <div class="placeholder-chart"></div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-6 mb-4">
                                <div class="card">
                                    <div class="card-header">
                                        <h6 class="card-title mb-0">Defect Severity Distribution</h6>
                                    </div>
                                    <div class="card-body">
                                        <div class="chart-container" style="height: 300px;">
                                            <!-- Chart will be rendered by JS -->
                                            <div class="placeholder-chart"></div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-6 mb-4">
                                <div class="card">
                                    <div class="card-header">
                                        <h6 class="card-title mb-0">Test Execution Trend</h6>
                                    </div>
                                    <div class="card-body">
                                        <div class="chart-container" style="height: 300px;">
                                            <!-- Chart will be rendered by JS -->
                                            <div class="placeholder-chart"></div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-6 mb-4">
                                <div class="card">
                                    <div class="card-header">
                                        <h6 class="card-title mb-0">Defect Status Distribution</h6>
                                    </div>
                                    <div class="card-body">
                                        <div class="chart-container" style="height: 300px;">
                                            <!-- Chart will be rendered by JS -->
                                            <div class="placeholder-chart"></div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                <button type="button" class="btn btn-primary">
                    <i class="fas fa-download me-2"></i>Download Full Report
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="{% static 'js/reporting/reporting.js' %}"></script>
{% endblock %}